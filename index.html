<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lune de Miel - Japon & Philippines 2026</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    
    <!-- Leaflet CSS & FontAwesome -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <meta name="theme-color" content="#e91e63">

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #e91e63;
            --secondary: #2196f3;
            --japan: #bc002d;
            --philippines: #0038a8;
            --success: #4caf50;
            --suggestion: #ff9800;
            --text: #333;
            --bg: #f8f9fa;
            --gradient-jp-ph: linear-gradient(135deg, var(--japan) 0%, var(--philippines) 100%);
            --radius: 12px;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 80px; }
        
        /* --- LANDING PAGE --- */
        #landing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: var(--gradient-jp-ph);
            z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            text-align: center; transition: transform 0.5s ease-in-out;
        }
        .btn-enter {
            padding: 15px 40px; background: white; color: var(--philippines);
            border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 30px; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-enter:active { transform: scale(0.95); }

        /* COUNTDOWN */
        .countdown-container { display: flex; gap: 15px; margin-top: 20px; }
        .countdown-box {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 10px; min-width: 80px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .countdown-number { font-size: 2rem; font-weight: bold; display: block; line-height: 1; }
        .countdown-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
        
        /* --- APP LAYOUT --- */
        #app-interface { display: none; opacity: 0; transition: opacity 0.5s; }
        
        header {
            position: sticky; top: 0; z-index: 1000;
            background: var(--gradient-jp-ph); color: white;
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100vh;
            background: white; z-index: 1500; transition: left 0.3s ease;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1); padding-top: 60px;
        }
        #sidebar.active { left: 0; }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(0,0,0,0.5); z-index: 1400; display: none;
        }
        .nav-link {
            display: flex; align-items: center; padding: 15px 25px;
            color: var(--text); text-decoration: none; border-bottom: 1px solid #eee;
        }
        
        .section { display: none; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        
        /* --- PLANNING --- */
        .day-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; margin-top: 20px;
        }
        .day-card {
            background: white; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out; 
        }
        .day-header { padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .bg-jp { background: var(--japan); }
        .bg-ph { background: var(--philippines); }
        .bg-intl { background: #607d8b; }
        
        /* SWIPE ANIMATIONS */
        .slide-in-right { animation: slideInRight 0.3s forwards; }
        .slide-in-left { animation: slideInLeft 0.3s forwards; }
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* COMPONENTS */
        .challenge-card {
            margin: 20px; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white; border-radius: var(--radius); overflow: hidden;
        }
        .challenge-header { padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .challenge-body { padding: 0 15px 15px; display: none; }
        .challenge-body.open { display: block; }
        .challenge-card.completed { background: var(--success); }
        
        .timeline { padding: 0 20px 20px; }
        .activity {
            border-left: 2px solid #ddd; padding-left: 20px; margin-bottom: 20px; position: relative;
        }
        .activity::before {
            content: ''; width: 10px; height: 10px; background: var(--primary);
            border-radius: 50%; position: absolute; left: -6px; top: 5px;
        }
        /* Liens Map */
        .map-link { text-decoration: none; color: inherit; transition: color 0.2s; }
        .map-link:hover { color: var(--secondary); }
        .map-icon-small { color: var(--secondary); font-size: 0.8rem; margin-left: 5px; }

        .hotel-card {
            background: #fff9c4; margin: 20px; padding: 15px;
            border-radius: var(--radius); border-left: 5px solid #fbc02d;
        }
        .hotel-details { margin-top: 10px; font-size: 0.9rem; color: #555; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px; }
        .hotel-badge { display: inline-block; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-size: 0.8rem; }
        
        #map-container { height: 60vh; border-radius: var(--radius); margin-top: 20px; }
        
        /* Custom Map Markers */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -15px 0 0 -15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .marker-pin::after { content: ''; width: 20px; height: 20px; margin: 5px 0 0 5px; background: #fff; position: absolute; border-radius: 50%; }
        .marker-pin i { transform: rotate(45deg); z-index: 10; font-size: 14px; color: #333; }
        
        /* AI MODAL STYLES */
        .ai-fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white; border: none; font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1600; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .ai-fab:hover { transform: scale(1.1); }

        .ai-modal {
            position: fixed; bottom: 90px; right: 20px; left: 20px;
            background: white; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1599; padding: 20px; display: none; flex-direction: column;
            max-width: 400px; margin-left: auto; border: 1px solid rgba(0,0,0,0.05);
            animation: slideUp 0.3s ease-out;
        }
        .ai-modal.active { display: flex; }
        
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .ai-title { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        .ai-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .ai-btn {
            padding: 10px; border: 1px solid #eee; border-radius: 8px;
            background: #f8f9fa; cursor: pointer; font-size: 0.85rem;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: all 0.2s; text-align: center;
        }
        .ai-btn:hover { background: #e3f2fd; border-color: var(--secondary); }
        .ai-btn i { color: var(--secondary); font-size: 1.2rem; }

        .ai-chat-box { height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        
        .ai-input-group { display: flex; gap: 10px; }
        .ai-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .ai-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        .chat-msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; }
        .chat-msg.user { background: var(--secondary); color: white; align-self: flex-end; }
        .chat-msg.ai { background: white; border: 1px solid #ddd; align-self: flex-start; }
        .typing-dots::after { content: ' . . .'; animation: dots 1.5s infinite; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes dots { 0% { content: ' .'; } 33% { content: ' . .'; } 66% { content: ' . . .'; } }
    </style>
</head>
<body>

    <!-- SCREEN D'ACCUEIL -->
    <div id="landing-page">
        <div class="landing-content">
            <h1>Lune de Miel</h1>
            <p>Japon & Philippines</p>
            <p style="font-size:0.9rem; opacity:0.8; margin-top:5px;">20 F√©v - 14 Mars 2026</p>
            <div class="countdown-container" id="countdown-display">
                <div class="countdown-box"><span class="countdown-number" id="cd-days">00</span><span class="countdown-label">Jours</span></div>
                <div class="countdown-box"><span class="countdown-number" id="cd-hours">00</span><span class="countdown-label">Heures</span></div>
                <div class="countdown-box"><span class="countdown-number" id="cd-minutes">00</span><span class="countdown-label">Min</span></div>
            </div>
            <button class="btn-enter" onclick="enterApp()">Acc√©der au planning</button>
        </div>
    </div>

    <!-- INTERFACE PRINCIPALE -->
    <div id="app-interface">
        <header>
            <button onclick="toggleSidebar()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: bold;">Voyage de Noces</div>
            <div id="header-date" style="font-size:0.9rem;">J-0</div>
        </header>

        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <nav id="sidebar">
            <button onclick="toggleSidebar()" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
            <a href="#" class="nav-link" onclick="navigate('planner')"><i class="fas fa-calendar-alt"></i> Planning Journalier</a>
            <a href="#" class="nav-link" onclick="navigate('map')"><i class="fas fa-globe-asia"></i> Carte Interactive</a>
            <a href="#" class="nav-link" onclick="navigate('hotels')"><i class="fas fa-hotel"></i> H√©bergements</a>
            <a href="#" class="nav-link" onclick="navigate('converter')"><i class="fas fa-exchange-alt"></i> Convertisseur</a>
        </nav>

        <!-- 1. PLANNING -->
        <section id="planner" class="section active">
            <div class="day-nav">
                <button onclick="changeDay(-1)" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">‚óÄ</button>
                <select id="day-select" onchange="selectDay(this.value)" style="padding:8px; border-radius:20px; border:1px solid #ccc;"></select>
                <button onclick="changeDay(1)" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">‚ñ∂</button>
            </div>
            <div id="day-content"></div>
            <p style="text-align:center; color:#999; font-size:0.8rem; margin-top:10px;">
                <i class="fas fa-hand-pointer"></i> Glissez gauche/droite pour changer de jour
            </p>
        </section>

        <!-- 2. CARTE -->
        <section id="map" class="section">
            <h2>üó∫Ô∏è Carte du Voyage</h2>
            <div class="map-legend" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; font-size:0.8rem;">
                <span style="display:flex; align-items:center;"><i class="fas fa-circle" style="color:var(--primary); margin-right:5px;"></i> Activit√©s</span>
                <span style="display:flex; align-items:center;"><i class="fas fa-circle" style="color:var(--secondary); margin-right:5px;"></i> H√¥tels</span>
                <span style="display:flex; align-items:center;"><i class="fas fa-circle" style="color:var(--suggestion); margin-right:5px;"></i> Id√©es</span>
            </div>
            <div id="map-container"></div>
        </section>
        
        <!-- 3. H√îTELS -->
        <section id="hotels" class="section">
            <h2>üè® Vos H√©bergements</h2>
            <div id="hotels-list"></div>
        </section>

        <!-- 4. CONVERTISSEUR -->
        <section id="converter" class="section">
            <h2>üí± Convertisseur</h2>
            <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); text-align:center;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="curr-from" onchange="convertCurrency()" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa;">
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="JPY">JPY (¬•)</option>
                        <option value="PHP">PHP (‚Ç±)</option>
                    </select>
                    <input type="number" id="amount-from" value="100" oninput="convertCurrency()" placeholder="Montant" style="flex:2; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1.1rem;">
                </div>
                <button onclick="swapCurrency()" style="background:none; border:none; font-size:1.5rem; margin:15px 0; cursor:pointer; color:var(--primary); transition:transform 0.2s;">
                    <i class="fas fa-exchange-alt" style="transform: rotate(90deg);"></i>
                </button>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="curr-to" onchange="convertCurrency()" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa;">
                        <option value="JPY">JPY (¬•)</option>
                        <option value="PHP">PHP (‚Ç±)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                    </select>
                    <div id="conversion-result" style="flex:2; font-size: 1.5rem; font-weight: bold; color: var(--primary); text-align:right;">---</div>
                </div>
                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                    <button onclick="updateRates()" id="btn-update-rates" style="background:var(--secondary); color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:8px; margin:0 auto;">
                        <i class="fas fa-sync-alt"></i> Actualiser les taux
                    </button>
                    <p id="rate-info" style="font-size:0.8rem; color:#999; margin-top:10px;">Taux indicatifs</p>
                </div>
            </div>
        </section>
    </div>

    <!-- AI MODAL -->
    <button class="ai-fab" onclick="toggleAIModal()">‚ú®</button>
    <div class="ai-modal" id="aiModal">
        <div class="ai-header">
            <div class="ai-title">‚ú® Compagnon IA <span style="font-size:0.7rem; font-weight:normal; color:#666;" id="ai-context-badge"></span></div>
            <button onclick="toggleAIModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>
        <div class="ai-actions">
            <button class="ai-btn" onclick="askGemini('Sugg√®re une activit√© romantique courte et spontan√©e ici (√† VilleActuelle).')">
                <i class="fas fa-heart"></i> Id√©e Romantique
            </button>
            <button class="ai-btn" onclick="activateTranslatorMode()">
                <i class="fas fa-language"></i> Traducteur
            </button>
            <button class="ai-btn" onclick="askGemini('Quelle est la sp√©cialit√© culinaire incontournable √† VilleActuelle ?')">
                <i class="fas fa-utensils"></i> Gastronomie
            </button>
            <button class="ai-btn" onclick="askGemini('Donne-moi un conseil culturel important ou une erreur √† √©viter au/en PaysActuel.')">
                <i class="fas fa-info-circle"></i> Culture
            </button>
        </div>
        <div class="ai-chat-box" id="aiChatBox">
            <div class="chat-msg ai">Bonjour ! Je suis votre guide pour ce voyage. Je sais que vous √™tes √† <b id="ai-location-name">Tokyo</b>. Comment puis-je vous aider ?</div>
        </div>
        <div class="ai-input-group">
            <input type="text" id="aiUserInput" class="ai-input" placeholder="Posez une question...">
            <button class="ai-send" onclick="handleUserSubmit()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /* --- CONFIG --- */
        const apiKey = "AIzaSyCvGcDb4H7qrTRvbj6VPwVntllM5RtP-xc"; 
        const DATE_DEPART = new Date('2026-02-20T18:50:00');
        
        // --- DONN√âES VOYAGE ---
        const voyageData = {
            days: [
                {
                    id: 1,
                    date: new Date('2026-02-20'),
                    country: 'International',
                    location: 'Vol Paris ‚Üí Istanbul',
                    coords: [48.8566, 2.3522],
                    hotel: { name: "Nuit √† bord", room: "Vol TK1828/TK198", link: "#" },
                    challenge: { title: "‚úàÔ∏è Premier envol", desc: "Photo coucher soleil avion", hint: "Hublot" },
                    activities: [
                        { time: "18:50", title: "D√©part Paris CDG", desc: "Vol TK1828", coords: [49.0097, 2.5479] },
                        { time: "23:30", title: "Nuit √† bord", desc: "Vers Istanbul", coords: null }
                    ]
                },
                {
                    id: 2,
                    date: new Date('2026-02-21'),
                    country: 'Japon',
                    location: 'Tokyo (Ginza)',
                    coords: [35.6712, 139.7665],
                    hotel: { name: "The B Ginza", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=The+B+Ginza" },
                    challenge: { title: "üèôÔ∏è Premiers pas √† Ginza", desc: "N√©ons de Ginza", hint: "Buildings illumin√©s" },
                    activities: [
                        { time: "19:45", title: "Arriv√©e Haneda", desc: "Transfert h√¥tel", coords: [35.5494, 139.7798] },
                        { time: "22:00", title: "Ginza Nocturne", desc: "Exploration", coords: [35.6712, 139.7665] }
                    ],
                    suggestions: [{ title: "Hibiya Park", desc: "Parc paisible", coords: [35.6736, 139.7564] }]
                },
                {
                    id: 3,
                    date: new Date('2026-02-22'),
                    country: 'Japon',
                    location: 'Tokyo (Asakusa)',
                    coords: [35.7148, 139.7967],
                    hotel: { name: "The B Ginza", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=The+B+Ginza" },
                    challenge: { title: "‚õ©Ô∏è Temple embl√©matique", desc: "Temple Senso-ji", hint: "T√¥t le matin" },
                    activities: [
                        { time: "09:00", title: "Temple Senso-ji", desc: "Asakusa", coords: [35.7148, 139.7967] },
                        { time: "13:30", title: "Parc Ueno", desc: "Mus√©es", coords: [35.7140, 139.7741] }
                    ],
                    suggestions: [{ title: "Ameyoko Market", desc: "March√© anim√©", coords: [35.7088, 139.7746] }]
                },
                {
                    id: 4,
                    date: new Date('2026-02-23'),
                    country: 'Japon',
                    location: 'Tokyo (Odaiba)',
                    coords: [35.6284, 139.7775],
                    hotel: { name: "The B Ginza", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=The+B+Ginza" },
                    challenge: { title: "üëë Jardins imp√©riaux", desc: "Jardins du Palais", hint: "Pont en bois" },
                    activities: [
                        { time: "09:30", title: "Palais Imp√©rial", desc: "Jardins", coords: [35.6852, 139.7528] },
                        { time: "14:00", title: "TeamLab Planets", desc: "Art immersif", coords: [35.6442, 139.7954] },
                        { time: "18:30", title: "Odaiba", desc: "Vue Baie", coords: [35.6284, 139.7775] }
                    ],
                    suggestions: [{ title: "Gundam Statue", desc: "Robot g√©ant", coords: [35.6244, 139.7755] }]
                },
                {
                    id: 5,
                    date: new Date('2026-02-24'),
                    country: 'Japon',
                    location: 'Tokyo (Shinjuku)',
                    coords: [35.6917, 139.7040],
                    hotel: { name: "The B Ginza", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=The+B+Ginza" },
                    challenge: { title: "üåÉ Vue panoramique", desc: "Sunshine 60", hint: "Coucher soleil" },
                    activities: [
                        { time: "09:30", title: "Hie-jinja", desc: "Sanctuaire", coords: [35.6746, 139.7400] },
                        { time: "13:00", title: "Sunshine 60", desc: "Observatoire", coords: [35.7295, 139.7180] },
                        { time: "18:00", title: "Shinjuku", desc: "N√©ons", coords: [35.6917, 139.7040] }
                    ],
                    suggestions: [{ title: "Omoide Yokocho", desc: "Ruelle r√©tro", coords: [35.6930, 139.6996] }]
                },
                {
                    id: 6,
                    date: new Date('2026-02-25'),
                    country: 'Japon',
                    location: 'Furano',
                    coords: [43.3421, 142.3832],
                    hotel: { name: "Winery Hotel Furano", room: "Vue Montagne", link: "https://www.google.com/maps/search/?api=1&query=Winery+Hotel+Furano" },
                    challenge: { title: "üèîÔ∏è Arriv√©e montagne", desc: "Montagnes enneig√©es", hint: "Vue h√¥tel" },
                    activities: [
                        { time: "11:10", title: "Vol vers Asahikawa", desc: "Hokkaido", coords: [43.6708, 142.4537] },
                        { time: "16:30", title: "Mat√©riel Ski", desc: "Location", coords: [43.3340, 142.3620] }
                    ],
                    suggestions: [{ title: "Ningle Terrace", desc: "Cabanes", coords: [43.3252, 142.3563] }]
                },
                {
                    id: 7,
                    date: new Date('2026-02-26'),
                    country: 'Japon',
                    location: 'Furano',
                    coords: [43.3421, 142.3832],
                    hotel: { name: "Winery Hotel Furano", room: "Vue Montagne", link: "https://www.google.com/maps/search/?api=1&query=Winery+Hotel+Furano" },
                    challenge: { title: "‚õ∑Ô∏è Ski", desc: "Action sur pistes", hint: "Piste bleue" },
                    activities: [
                        { time: "09:30", title: "Ski Furano", desc: "Glisse", coords: [43.3340, 142.3620] },
                        { time: "17:30", title: "Onsen", desc: "D√©tente", coords: [43.3421, 142.3832] }
                    ],
                    suggestions: []
                },
                {
                    id: 8,
                    date: new Date('2026-02-27'),
                    country: 'Japon',
                    location: 'Furano',
                    coords: [43.3421, 142.3832],
                    hotel: { name: "Winery Hotel Furano", room: "Vue Montagne", link: "https://www.google.com/maps/search/?api=1&query=Winery+Hotel+Furano" },
                    challenge: { title: "üéø Hors-piste", desc: "Poudreuse avec guide", hint: "Nature" },
                    activities: [
                        { time: "09:30", title: "Guide Local", desc: "Hors-piste", coords: [43.3500, 142.3700] }
                    ],
                    suggestions: [{ title: "Furano Delice", desc: "P√¢tisserie", coords: [43.3350, 142.3650] }]
                },
                {
                    id: 9,
                    date: new Date('2026-02-28'),
                    country: 'Japon',
                    location: 'Furano',
                    coords: [43.3421, 142.3832],
                    hotel: { name: "Winery Hotel Furano", room: "Vue Montagne", link: "https://www.google.com/maps/search/?api=1&query=Winery+Hotel+Furano" },
                    challenge: { title: "üç∑ D√©gustation", desc: "Vin Furano", hint: "Vignes" },
                    activities: [
                        { time: "10:00", title: "Fromagerie", desc: "Visite", coords: [43.3094, 142.3941] },
                        { time: "14:00", title: "D√©gustation Vin", desc: "Cave", coords: [43.3475, 142.3816] }
                    ],
                    suggestions: []
                },
                {
                    id: 10,
                    date: new Date('2026-03-01'),
                    country: 'Japon',
                    location: 'Furano',
                    coords: [43.3421, 142.3832],
                    hotel: { name: "Winery Hotel Furano", room: "Vue Montagne", link: "https://www.google.com/maps/search/?api=1&query=Winery+Hotel+Furano" },
                    challenge: { title: "‚ùÑÔ∏è Dernier ski", desc: "Groupe √©quipement", hint: "Panneau station" },
                    activities: [
                        { time: "09:30", title: "Matin√©e Ski", desc: "Pistes", coords: [43.3340, 142.3620] },
                        { time: "19:00", title: "D√Æner Adieu", desc: "Hokkaido", coords: [43.3428, 142.3860] }
                    ],
                    suggestions: []
                },
                {
                    id: 11,
                    date: new Date('2026-03-02'),
                    country: 'Japon',
                    location: 'Kyoto',
                    coords: [34.9858, 135.7588],
                    hotel: { name: "Insomnia KYOTO OIKE", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=Insomnia+Kyoto+Oike" },
                    challenge: { title: "üéé Arriv√©e Kyoto", desc: "Gare de Kyoto", hint: "Architecture" },
                    activities: [
                        { time: "14:00", title: "Vol vers Osaka", desc: "Itami", coords: [34.7855, 135.4382] },
                        { time: "18:30", title: "Arriv√©e Kyoto", desc: "Installation", coords: [35.0116, 135.7600] }
                    ],
                    suggestions: [{ title: "Kyoto Tower", desc: "Vue nocturne", coords: [34.9875, 135.7593] }]
                },
                {
                    id: 12,
                    date: new Date('2026-03-03'),
                    country: 'Japon',
                    location: 'Kyoto (Nord)',
                    coords: [35.0394, 135.7292],
                    hotel: { name: "Insomnia KYOTO OIKE", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=Insomnia+Kyoto+Oike" },
                    challenge: { title: "üèØ Pavillon d'Or", desc: "Reflet Kinkaku-ji", hint: "Rive oppos√©e" },
                    activities: [
                        { time: "09:00", title: "Kinkaku-ji", desc: "Pavillon d'Or", coords: [35.0394, 135.7292] },
                        { time: "11:30", title: "March√© Nishiki", desc: "D√©jeuner", coords: [35.0050, 135.7649] },
                        { time: "19:00", title: "Gion", desc: "D√Æner", coords: [35.0037, 135.7778] }
                    ],
                    suggestions: [{ title: "Ryoan-ji", desc: "Jardin zen", coords: [35.0345, 135.7182] }]
                },
                {
                    id: 13,
                    date: new Date('2026-03-04'),
                    country: 'Japon',
                    location: 'Kyoto (Est)',
                    coords: [34.9671, 135.7727],
                    hotel: { name: "Insomnia KYOTO OIKE", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=Insomnia+Kyoto+Oike" },
                    challenge: { title: "‚õ©Ô∏è Torii infinis", desc: "Fushimi Inari", hint: "Haut colline" },
                    activities: [
                        { time: "07:30", title: "Fushimi Inari", desc: "Sanctuaire", coords: [34.9671, 135.7727] },
                        { time: "10:00", title: "Chemin Philosophe", desc: "Promenade", coords: [35.0265, 135.7955] },
                        { time: "18:00", title: "Pontocho", desc: "Soir√©e", coords: [35.0064, 135.7709] }
                    ],
                    suggestions: [{ title: "Ginkaku-ji", desc: "Pavillon d'Argent", coords: [35.0270, 135.7982] }]
                },
                {
                    id: 14,
                    date: new Date('2026-03-05'),
                    country: 'Japon',
                    location: 'Nara',
                    coords: [34.6851, 135.8048],
                    hotel: { name: "Insomnia KYOTO OIKE", room: "Chambre Double", link: "https://www.google.com/maps/search/?api=1&query=Insomnia+Kyoto+Oike" },
                    challenge: { title: "ü¶å Cerfs sacr√©s", desc: "Parc de Nara", hint: "Biscuits" },
                    activities: [
                        { time: "09:45", title: "Todai-ji", desc: "Grand Bouddha", coords: [34.6889, 135.8398] },
                        { time: "11:30", title: "Parc de Nara", desc: "Balade", coords: [34.6850, 135.8430] }
                    ],
                    suggestions: [{ title: "Kasuga Taisha", desc: "Sanctuaire lanternes", coords: [34.6814, 135.8484] }]
                },
                {
                    id: 15,
                    date: new Date('2026-03-06'),
                    country: 'Japon',
                    location: 'Arashiyama',
                    coords: [35.0116, 135.6716],
                    hotel: { name: "Vol Nuit", room: "Si√®ge Avion", link: "#" },
                    challenge: { title: "üéã Bambous", desc: "For√™t Arashiyama", hint: "Matin t√¥t" },
                    activities: [
                        { time: "09:00", title: "For√™t Bambous", desc: "Visite", coords: [35.0169, 135.6713] },
                        { time: "19:35", title: "Vol Manille", desc: "D√©part", coords: [34.4320, 135.2304] }
                    ],
                    suggestions: [{ title: "Monkey Park", desc: "Singes", coords: [35.0094, 135.6744] }]
                },
                {
                    id: 16,
                    date: new Date('2026-03-07'),
                    country: 'Philippines',
                    location: 'Bohol (Loboc)',
                    coords: [9.6378, 124.0331],
                    hotel: { name: "Fox & The Firefly", room: "Cottage", link: "https://www.google.com/maps/search/?api=1&query=Fox+and+The+Firefly+Bohol" },
                    challenge: { title: "üå¥ Arriv√©e", desc: "Lodge & Rivi√®re", hint: "Terrasse" },
                    activities: [
                        { time: "08:30", title: "Arriv√©e Bohol", desc: "Installation", coords: [9.6378, 124.0331] },
                        { time: "20:00", title: "Lucioles", desc: "Rivi√®re", coords: [9.6385, 124.0300] }
                    ],
                    suggestions: []
                },
                {
                    id: 17,
                    date: new Date('2026-03-08'),
                    country: 'Philippines',
                    location: 'Bohol (Centre)',
                    coords: [9.8297, 124.1397],
                    hotel: { name: "Fox & The Firefly", room: "Cottage", link: "https://www.google.com/maps/search/?api=1&query=Fox+and+The+Firefly+Bohol" },
                    challenge: { title: "üç´ Chocolate Hills", desc: "Vue collines", hint: "Plateforme" },
                    activities: [
                        { time: "09:00", title: "Chocolate Hills", desc: "Visite", coords: [9.8297, 124.1397] },
                        { time: "10:30", title: "Tarsiers", desc: "Sanctuaire", coords: [9.6918, 124.0096] },
                        { time: "12:30", title: "Croisi√®re Loboc", desc: "D√©jeuner", coords: [9.6391, 124.0299] }
                    ],
                    suggestions: [{ title: "Man Made Forest", desc: "For√™t acajou", coords: [9.6960, 124.0710] }]
                },
                {
                    id: 18,
                    date: new Date('2026-03-09'),
                    country: 'Philippines',
                    location: 'Panglao',
                    coords: [9.55, 123.77],
                    hotel: { name: "Amorita Resort", room: "Suite Luxe", link: "https://www.google.com/maps/search/?api=1&query=Amorita+Resort+Bohol" },
                    challenge: { title: "üèùÔ∏è Resort", desc: "Infinity Pool", hint: "Coucher soleil" },
                    activities: [
                        { time: "11:00", title: "Amorita Resort", desc: "Installation", coords: [9.5483, 123.7764] },
                        { time: "18:00", title: "Sunset", desc: "Plage", coords: [9.5480, 123.7760] }
                    ],
                    suggestions: [{ title: "Alona Beach", desc: "Bars", coords: [9.5483, 123.7764] }]
                },
                {
                    id: 19,
                    date: new Date('2026-03-10'),
                    country: 'Philippines',
                    location: 'Balicasag',
                    coords: [9.5191, 123.6811],
                    hotel: { name: "Amorita Resort", room: "Suite Luxe", link: "https://www.google.com/maps/search/?api=1&query=Amorita+Resort+Bohol" },
                    challenge: { title: "üê† Plong√©e", desc: "Selfie sous-marin", hint: "R√©cif" },
                    activities: [
                        { time: "09:00", title: "Plong√©e PADI", desc: "Balicasag", coords: [9.5191, 123.6811] },
                        { time: "16:00", title: "Retour", desc: "Resort", coords: [9.5483, 123.7764] }
                    ],
                    suggestions: []
                },
                {
                    id: 20,
                    date: new Date('2026-03-11'),
                    country: 'Philippines',
                    location: 'Panglao',
                    coords: [9.55, 123.77],
                    hotel: { name: "Amorita Resort", room: "Suite Luxe", link: "https://www.google.com/maps/search/?api=1&query=Amorita+Resort+Bohol" },
                    challenge: { title: "üê¨ Dauphins", desc: "Photo mer", hint: "Bateau" },
                    activities: [
                        { time: "08:00", title: "Dauphins", desc: "Excursion", coords: [9.5300, 123.7500] },
                        { time: "19:00", title: "D√Æner Plage", desc: "Romantique", coords: [9.5483, 123.7764] }
                    ],
                    suggestions: [{ title: "Hinagdanan Cave", desc: "Grotte", coords: [9.6250, 123.8000] }]
                },
                {
                    id: 21,
                    date: new Date('2026-03-12'),
                    country: 'Philippines',
                    location: 'Panglao',
                    coords: [9.55, 123.77],
                    hotel: { name: "Amorita Resort", room: "Suite Luxe", link: "https://www.google.com/maps/search/?api=1&query=Amorita+Resort+Bohol" },
                    challenge: { title: "üåÖ Sunset", desc: "Photo romantique", hint: "Sable" },
                    activities: [
                        { time: "09:00", title: "D√©tente", desc: "Resort", coords: [9.5483, 123.7764] },
                        { time: "18:00", title: "D√Æner Adieu", desc: "Philippines", coords: [9.5483, 123.7764] }
                    ],
                    suggestions: []
                },
                {
                    id: 22,
                    date: new Date('2026-03-13'),
                    country: 'International',
                    location: 'Vol Retour',
                    coords: [14.51, 121.01],
                    hotel: { name: "Nuit √† bord", room: "Vol EK335", link: "#" },
                    challenge: { title: "üëã Adieu", desc: "Derni√®re photo", hint: "A√©roport" },
                    activities: [
                        { time: "14:00", title: "Check-out", desc: "D√©part", coords: [9.5483, 123.7764] },
                        { time: "18:50", title: "Vol Manille", desc: "D√©part", coords: [14.51, 121.01] }
                    ],
                    suggestions: []
                },
                {
                    id: 23,
                    date: new Date('2026-03-14'),
                    country: 'France',
                    location: 'Arriv√©e Paris',
                    coords: [48.8566, 2.3522],
                    hotel: { name: "Maison", room: "Chez vous", link: "#" },
                    challenge: { title: "üè† Retour", desc: "Arriv√©e Paris", hint: "Hall CDG" },
                    activities: [
                        { time: "07:50", title: "Vol vers Paris", desc: "EK073", coords: null },
                        { time: "12:25", title: "Arriv√©e", desc: "Fin voyage", coords: [49.0097, 2.5479] }
                    ],
                    suggestions: []
                }
            ],
            hotels: [
                { 
                    name: "The B Ginza", city: "Tokyo", stars: 4,
                    coords: [35.6695, 139.7615],
                    checkIn: "15:00", checkOut: "11:00",
                    amenities: ["Wifi", "Caf√© gratuit", "Clim", "Centre ville"],
                    desc: "H√¥tel moderne au c≈ìur du quartier chic de Ginza. Id√©al pour le shopping et les d√Æners."
                },
                { 
                    name: "Winery Hotel Furano", city: "Furano", stars: 4,
                    coords: [43.3421, 142.3832],
                    checkIn: "15:00", checkOut: "10:00",
                    amenities: ["Onsen", "Vue Montagne", "Navette Ski", "Restaurant"],
                    desc: "H√¥tel perch√© avec vue panoramique sur les montagnes et vignobles."
                },
                { 
                    name: "Insomnia KYOTO OIKE", city: "Kyoto", stars: 4,
                    coords: [35.0116, 135.7600], 
                    checkIn: "14:00", checkOut: "11:00",
                    amenities: ["Design", "Wifi", "Bar 24h", "Central"],
                    desc: "H√¥tel moderne et artistique id√©alement situ√© pr√®s du march√© Nishiki et des transports."
                },
                { 
                    name: "Fox & The Firefly", city: "Loboc", stars: 3,
                    coords: [9.6378, 124.0331],
                    checkIn: "14:00", checkOut: "12:00",
                    amenities: ["Eco-Lodge", "Bord rivi√®re", "Nature", "Paddle"],
                    desc: "Cottages en bambou au bord de la rivi√®re Loboc. Ambiance nature et d√©connect√©e."
                },
                { 
                    name: "Amorita Resort", city: "Panglao", stars: 5,
                    coords: [9.5483, 123.7764],
                    checkIn: "14:00", checkOut: "12:00",
                    amenities: ["Infinity Pool", "Plage priv√©e", "Spa", "Plong√©e"],
                    desc: "Luxe discret sur une falaise surplombant la plage d'Alona. Calme et volupt√©."
                }
            ]
        };

        let currentDayIndex = 0;
        let map = null;
        let exchangeRates = { "EUR-JPY": 162.50, "JPY-EUR": 0.0061, "EUR-PHP": 61.20, "PHP-EUR": 0.016 };

        document.addEventListener('DOMContentLoaded', () => {
            startCountdown();
            renderDayNav();
            renderDay(0);
            renderHotels();
            setupSwipe();
            updateAIContext(); // Initialise AI context
        });

        function startCountdown() {
            const update = () => {
                const now = new Date().getTime();
                const distance = DATE_DEPART.getTime() - now;
                if (distance < 0) {
                    document.getElementById('countdown-display').innerHTML = "<h3>EN VOYAGE ! ‚úàÔ∏è</h3>";
                    document.getElementById("header-date").innerText = "J-0";
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById("cd-days").innerText = days < 10 ? "0"+days : days;
                document.getElementById("cd-hours").innerText = hours < 10 ? "0"+hours : hours;
                document.getElementById("cd-minutes").innerText = minutes < 10 ? "0"+minutes : minutes;
                document.getElementById("header-date").innerText = "J-" + days;
            };
            setInterval(update, 1000);
            update();
        }

        function renderDayNav() {
            const select = document.getElementById('day-select');
            select.innerHTML = "";
            voyageData.days.forEach((day, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = `Jour ${day.id} - ${day.date.toLocaleDateString('fr-FR', {day:'numeric', month:'short'})}`;
                select.appendChild(opt);
            });
        }

        function selectDay(index, direction = null) { 
            currentDayIndex = parseInt(index); 
            renderDay(currentDayIndex, direction);
            updateAIContext(); // Update AI Context when day changes
        }
        
        function changeDay(offset, direction = null) {
            let newIndex = currentDayIndex + offset;
            if(newIndex >= 0 && newIndex < voyageData.days.length) {
                if (!direction) direction = offset > 0 ? 'right' : 'left';
                selectDay(newIndex, direction);
                document.getElementById('day-select').value = newIndex;
            }
        }

        function renderDay(index, direction = null) {
            const day = voyageData.days[index];
            const container = document.getElementById('day-content');
            const themeClass = day.country === 'Japon' ? 'bg-jp' : (day.country === 'Philippines' ? 'bg-ph' : 'bg-intl');
            const isChallengeDone = localStorage.getItem('challenge_'+day.id) === 'true';
            
            let animClass = '';
            if (direction === 'right') animClass = 'slide-in-right';
            if (direction === 'left') animClass = 'slide-in-left';

            let suggestionsHtml = "";
            if(day.suggestions && day.suggestions.length > 0) {
                suggestionsHtml = `
                    <div style="margin-top:20px; background:#fff3e0; padding:15px; border-radius:12px; border-left:4px solid var(--suggestion);">
                        <h4 style="margin-bottom:10px; color:#e65100;"><i class="fas fa-lightbulb"></i> Id√©es temps libre</h4>
                        ${day.suggestions.map(s => `<div style="margin-bottom:5px;"><strong><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.title + " " + day.location)}" target="_blank" class="map-link">${s.title} <i class="fas fa-external-link-alt map-icon-small"></i></a></strong>: ${s.desc}</div>`).join('')}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="day-card ${animClass}">
                    <div class="day-header ${themeClass}">
                        <div>
                            <h2>${day.date.toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric', month: 'long'})}</h2>
                            <p><i class="fas fa-map-marker-alt"></i> ${day.location}</p>
                        </div>
                        <i class="fas ${day.country === 'Japon' ? 'fa-torii-gate' : (day.country === 'Philippines' ? 'fa-sun' : 'fa-plane')} fa-2x"></i>
                    </div>
                    
                    <div class="challenge-card ${isChallengeDone ? 'completed' : ''}" id="chal-${day.id}">
                        <div class="challenge-header" onclick="this.nextElementSibling.classList.toggle('open')">
                            <i class="fas fa-camera"></i> 
                            <strong style="flex:1">${isChallengeDone ? 'Souvenir cr√©√© !' : day.challenge.title}</strong>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="challenge-body">
                            <p>${day.challenge.desc}</p>
                            <small style="display:block; margin:10px 0; opacity:0.8;">üí° ${day.challenge.hint}</small>
                            ${!isChallengeDone ? `
                                <button onclick="completeChallenge(${day.id})" style="background:white; color:#333; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer; margin-top:5px;">
                                    üì∏ Valider le d√©fi
                                </button>` 
                            : ''}
                        </div>
                    </div>

                    <div class="timeline">
                        ${day.activities.map(act => `
                            <div class="activity">
                                <div style="color:var(--primary);font-weight:bold;">${act.time}</div>
                                <strong>
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(act.title + " " + day.location)}" target="_blank" class="map-link">
                                        ${act.title} <i class="fas fa-external-link-alt map-icon-small"></i>
                                    </a>
                                </strong>
                                <p style="font-size:0.9rem; color:#666;">${act.desc}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${suggestionsHtml}

                    <div class="hotel-card">
                        <strong>üè® <a href="${day.hotel.link}" target="_blank" class="map-link">${day.hotel.name} <i class="fas fa-external-link-alt map-icon-small"></i></a></strong><br>
                        <span style="font-size:0.9rem">${day.hotel.room}</span>
                    </div>
                </div>
            `;
        }

        function completeChallenge(id) {
            localStorage.setItem('challenge_'+id, 'true');
            renderDay(currentDayIndex);
            if(navigator.vibrate) navigator.vibrate(200);
        }
        
        function renderHotels() {
             const list = document.getElementById('hotels-list');
             if (list) {
                 list.innerHTML = voyageData.hotels.map(h => `
                    <div class="day-card" style="padding:15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0;">${h.name}</h3>
                            <div style="color:#fbc02d;">${"‚≠ê".repeat(h.stars)}</div>
                        </div>
                        <p style="color:#666; margin:5px 0;"><i class="fas fa-map-pin"></i> ${h.city}</p>
                        <p style="font-size:0.9rem; margin-bottom:10px;">${h.desc}</p>
                        
                        <div class="hotel-details">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>üïí Check-in: <strong>${h.checkIn}</strong></span>
                                <span>Check-out: <strong>${h.checkOut}</strong></span>
                            </div>
                            <div style="margin-top:8px;">
                                ${h.amenities.map(a => `<span class="hotel-badge">${a}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                 `).join('');
             }
        }

        function initMap() {
            if(map) return;
            map = L.map('map-container').setView([25, 130], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OSM'}).addTo(map);
            
            // 1. H√¥tels (Bleu)
            voyageData.hotels.forEach(h => {
                if(h.coords) {
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="marker-pin" style="background:#2196f3;"><i class="fas fa-bed"></i></div>`,
                        iconSize: [30, 42], iconAnchor: [15, 42]
                    });
                    L.marker(h.coords, {icon: icon}).addTo(map).bindPopup(`<b>${h.name}</b><br>H√¥tel`);
                }
            });

            // 2. TOUTES les Activit√©s (Rouge) + Suggestions (Orange)
            voyageData.days.forEach(d => {
                // Loop through activities
                d.activities.forEach(act => {
                    if(act.coords) {
                         const iconAct = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="marker-pin" style="background:#e91e63;"><i class="fas fa-camera"></i></div>`,
                            iconSize: [30, 42], iconAnchor: [15, 42]
                        });
                        L.marker(act.coords, {icon: iconAct}).addTo(map).bindPopup(`<b>Jour ${d.id}: ${act.title}</b><br>${act.desc}`);
                    }
                });

                // Suggestions
                if(d.suggestions) {
                    d.suggestions.forEach(s => {
                        const iconSugg = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="marker-pin" style="background:#ff9800;"><i class="fas fa-lightbulb"></i></div>`,
                            iconSize: [30, 42], iconAnchor: [15, 42]
                        });
                        L.marker(s.coords, {icon: iconSugg}).addTo(map).bindPopup(`<b>Suggestion: ${s.title}</b><br>${s.desc}`);
                    });
                }
            });
        }
        
        /* --- UTILS (Currency, AI, etc.) --- */
        async function updateRates() {
            const btn = document.getElementById('btn-update-rates');
            const info = document.getElementById('rate-info');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLLj3YWEjnNtTwjxM_6CZCB354sMQFQNaW0JkldsHsr-NFn7nHXQ6oxM73bUuuEbPMxTftpnkHb7fy/pub?gid=0&single=true&output=csv';
            try {
                const response = await fetch(sheetUrl);
                const text = await response.text();
                const rows = text.split('\n').map(row => {
                    const cols = row.split(',');
                    return cols.length > 1 ? parseFloat(cols[1]) : parseFloat(cols[0]);
                });
                if (rows.length >= 4) {
                    exchangeRates["EUR-JPY"] = rows[0]; exchangeRates["JPY-EUR"] = rows[1];
                    exchangeRates["EUR-PHP"] = rows[2]; exchangeRates["PHP-EUR"] = rows[3];
                    btn.innerHTML = '<i class="fas fa-check"></i> Taux √† jour !';
                    btn.style.background = "var(--success)";
                    info.innerText = "Derni√®re mise √† jour : " + new Date().toLocaleTimeString();
                    convertCurrency();
                    setTimeout(() => { btn.innerHTML = originalText; btn.style.background = "var(--secondary)"; }, 3000);
                }
            } catch (error) {
                console.error("Erreur chargement taux:", error);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur';
                btn.style.background = "#f44336";
            }
        }

        function convertCurrency() {
            const amount = parseFloat(document.getElementById('amount-from').value);
            const from = document.getElementById('curr-from').value;
            const to = document.getElementById('curr-to').value;
            const resultDiv = document.getElementById('conversion-result');
            if (isNaN(amount)) { resultDiv.innerText = "---"; return; }
            if (from === to) { resultDiv.innerText = amount.toFixed(2) + " " + to; return; }
            let rate = 0;
            const pair = `${from}-${to}`;
            if (exchangeRates[pair]) { rate = exchangeRates[pair]; } 
            else {
                const toEuro = `${from}-EUR`; const fromEuro = `EUR-${to}`;
                if (exchangeRates[toEuro] && exchangeRates[fromEuro]) { rate = exchangeRates[toEuro] * exchangeRates[fromEuro]; }
            }
            if (rate > 0) { resultDiv.innerText = (amount * rate).toFixed(2) + " " + (to === 'JPY' ? '' : '') + to; } 
            else { resultDiv.innerText = "?"; }
        }

        function swapCurrency() {
            const fromEl = document.getElementById('curr-from');
            const toEl = document.getElementById('curr-to');
            const temp = fromEl.value; fromEl.value = toEl.value; toEl.value = temp;
            convertCurrency();
        }

        function setupSwipe() {
            const container = document.getElementById('day-content');
            let touchStartX = 0; let touchEndX = 0; const minSwipeDistance = 50;
            container.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
            container.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});
            function handleSwipe() {
                const distance = touchEndX - touchStartX;
                if (Math.abs(distance) < minSwipeDistance) return;
                if (distance > 0) { changeDay(-1, 'left'); } else { changeDay(1, 'right'); }
            }
        }

        function toggleAIModal() { document.getElementById('aiModal').classList.toggle('active'); }
        
        function updateAIContext() {
            const day = voyageData.days[currentDayIndex];
            const locName = document.getElementById('ai-location-name');
            const contextBadge = document.getElementById('ai-context-badge');
            
            if(locName) locName.innerText = day.location;
            if(contextBadge) contextBadge.innerText = `‚Ä¢ ${day.country}`;
        }

        function askGemini(p){ addMessage("user", p); callGemini(p); }
        
        function activateTranslatorMode() {
            const day = voyageData.days[currentDayIndex];
            const lang = day.country === 'Japon' ? 'Japonais' : (day.country === 'Philippines' ? 'Tagalog' : 'Anglais');
            const prompt = `Agis comme un traducteur. Je vais te donner des phrases en fran√ßais, traduis-les uniquement en ${lang} avec la prononciation. Dis 'Pr√™t' pour commencer.`;
            addMessage("user", "Mode Traducteur");
            callGemini(prompt);
        }
        
        function handleUserSubmit(){ 
            const input = document.getElementById('aiUserInput');
            const text = input.value.trim();
            if(text) { addMessage("user", text); callGemini(text); input.value = ""; }
        }
        
        // Allow Enter key to submit
        document.getElementById('aiUserInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleUserSubmit();
        });

        function addMessage(sender, text) {
             const chatBox = document.getElementById('aiChatBox');
             const msgDiv = document.createElement('div');
             msgDiv.className = `chat-msg ${sender}`;
             msgDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
             chatBox.appendChild(msgDiv);
             chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function addLoading() {
            const chatBox = document.getElementById('aiChatBox');
            const loadDiv = document.createElement('div');
            loadDiv.id = "ai-loading";
            loadDiv.className = "chat-msg ai typing-dots";
            loadDiv.innerText = "R√©fl√©chit";
            chatBox.appendChild(loadDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeLoading() {
            const loadDiv = document.getElementById('ai-loading');
            if(loadDiv) loadDiv.remove();
        }

        async function callGemini(prompt) {
            if (!apiKey) {
                addMessage("ai", "Erreur: Cl√© API manquante.");
                return;
            }

            const day = voyageData.days[currentDayIndex];
            const systemContext = `Tu es un guide de voyage expert et romantique pour un couple en lune de miel. 
            Ils sont actuellement √† ${day.location} (${day.country}). C'est le jour ${day.id} de leur voyage (Date: ${day.date.toLocaleDateString()}).
            R√©ponds de mani√®re concise, utile et chaleureuse (max 2-3 phrases sauf si demand√© autrement).
            Si c'est une demande de traduction, donne la phrase en langue locale (${day.country === 'Japon' ? 'Japonais' : (day.country === 'Philippines' ? 'Tagalog/Visayan' : 'Anglais')}) et la phon√©tique.`;

            const fullPrompt = prompt.replace('VilleActuelle', day.location).replace('PaysActuel', day.country);

            addLoading();

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: systemContext + "\n\nUser: " + fullPrompt }]
                        }]
                    })
                });
                
                const data = await response.json();
                removeLoading();
                
                if (data.candidates && data.candidates[0].content) {
                    const reply = data.candidates[0].content.parts[0].text;
                    addMessage("ai", reply);
                } else {
                    addMessage("ai", "D√©sol√©, je n'ai pas pu traiter cette demande.");
                }

            } catch (error) {
                removeLoading();
                addMessage("ai", "Erreur de connexion au service IA.");
                console.error(error);
            }
        }
        
        function navigate(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            toggleSidebar();
            if(id === 'map' && map) setTimeout(() => map.invalidateSize(), 200);
        }
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            const overlay = document.querySelector('.sidebar-overlay');
            if(overlay) overlay.style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
        }
        function enterApp() {
            document.getElementById('landing-page').style.transform = 'translateY(-100%)';
            document.getElementById('app-interface').style.display = 'block';
            setTimeout(() => { document.getElementById('app-interface').style.opacity = '1'; initMap(); }, 500);
        }
    </script>
</body>
</html>
